<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="custom.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>
<body style="color: white;">
    <div class="container vh-100 d-flex flex-column align-items-center p-2">
        <div class="row container d-flex align-items-center text-center p-1 m-1 highlightBox">
            <div class="d-flex">
                <button class="btn btn-Danger float-left"data-bs-toggle="modal" data-bs-target="#leaveModal">Leave Game</button>
            </div>
            <div id="hostname" class="container fw-bold">
                The host is
            </div>
        </div>
        <div class="row container d-flex flex-column align-items-center text-center p-1 m-1 highlightBox">
            <div id="adminonly" class="row"  style="display: none">
                <button data-bs-toggle="modal" data-bs-target="#clearModal" class="btn col btn-Danger align-items-center">Clear all songs</button>
                <button data-bs-toggle="modal" data-bs-target="#submitModal" class="btn col btn-Primary align-items-center">Submit to spotify</button>
            </div>
            <div class="row">
                <div class="col align-items-center text-center fw-bold">
                    Player count
                    <div id="playercount">4</div>
                </div>
                <div class="col align-items-center text-center fw-bold">
                    Song Count
                    <div id="playlistcount">4</div>
                </div>
            </div>
        </div>
        <div class="row container align-items-center text-center p-1 m-1 highlightBox">
            <div class="fw-bold" >
                Your songs
                <div class="fs-6 fw-normal fst-italic" id="yoursongcount">
                    0/0
                </div>
            </div>
            <div id="yoursongs" style="color: white;overflow-y: scroll;max-height: 50vh;" class="d-flex flex-column">
                <div class="songBox d-none" id="examplesong">
                    <img src="" alt="Thumbnail" class="song-thumbnail">
                    <div class="yoursonglabel" style="flex-grow: 1;">
                        <div class="songname fw-bold">Song Name</div>
                        <i><small class="songartist">Artist Name</small></i>
                    </div>
                    <div><button onclick="remove(0)" class="btn btn-Danger">X</button></div>
                </div>
            </div>
        </div>
        <div class="row container align-items-center text-center p-1 m-1">
            <button class="btn btn-primary btn-lg align-items-center" data-bs-toggle="modal" data-bs-target="#addModal">Add new song</button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="addModalLabel">Add new song</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body align-items-center text-center">
                <div class="alert alert-warning" style="display: none;" role="alert" id="addModalError">Song already exists</div>
                <div class="input-group">
                    <input type="text" class="form-control" id="songinput" style="background-color: white;" placeholder="Song title" autocomplete="off">
                    <div class="input-group-append">
                        <button id="searchbutton" type="button" onclick="searchSongs()" class="btn btn-primary">
                            <img style="height: 25px" src="magnifying-glass.svg"/>
                        </button>
                    </div>
                </div>
                <div class="spinner-border text-light mt-5" id="searchloader" style="display: none;" role="status">
                </div>
                <div class="songBox clicksong d-none" id="exampleaddsong">
                    <img src="" alt="Thumbnail" class="song-thumbnail">
                    <div class="yoursonglabel" style="flex-grow: 1;">
                        <div class="songname fw-bold">Song Name</div>
                        <i><small class="songartist">Artist Name</small></i>
                    </div>
                </div>
                <div id="suggestions" style="color: white;overflow-y: scroll;max-height: 50vh;" class="d-flex flex-column">
                </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
        </div>
    </div>

        <!-- Modal -->
        <div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="submitModalLabel">Submit to Spotify?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body align-items-center text-center">
                    This will stop all other players from adding songs, and the game will begin
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-Danger" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="submit()">Yes</button>
                </div>
            </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="clearModal" tabindex="-1" aria-labelledby="clearModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="clearModalLabel">Clear all songs?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-Danger" data-bs-dismiss="modal" onclick="clearPlaylist()">Yes</button>
                </div>
            </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="leaveModal" tabindex="-1" aria-labelledby="leaveModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="leaveModalLabel">Leave Game?</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="leaveText" class="modal-body align-items-center text-center">
                    Are you sure you want to leave the game?
                    If you are the Host, this will close the game.
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-Primary" data-bs-dismiss="modal">Stay</button>
                <button type="button" class="btn btn-Danger" data-bs-dismiss="modal" onclick="leaveGame()">Leave</button>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Playlist building phase is over</h1>
                </div>
                <div id="endGameBody" class="modal-body">
                    The host has submitted the playlist and now has the spotify link. The game can now begin! You can now leave the game.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-Danger" data-bs-dismiss="modal" onclick="leaveGame()">Leave</button>
                    <button type="button" id="spotLink" class="btn btn-primary d-none" onclick="window.open(playlistLink, '_blank');">Link to Spotify</button>
                </div>
            </div>
            </div>
        </div>
</body>
</html>

<script>

    var playerID = localStorage.getItem("playerID");
    if (playerID == null){
        playerID = uuidv4();
        localStorage.setItem("playerID", playerID)
    }

    const urlParams = new URLSearchParams(window.location.search);

    const paramPlayerID = urlParams.get('playerID')
    if (paramPlayerID != playerID){
        window.location = `/?playerID=${playerID}`;
    }

    var search = ""
    var searching = false

    var playlistLink = ""

    document.addEventListener('DOMContentLoaded', async () => {
        const input = document.getElementById('songinput');
        const suggestions = document.getElementById('suggestions');
    
        infoRequest = await fetch(`/loadinfo?playerID=${playerID}`);
        info = await infoRequest.json();

        if (!info.validGame) {
            window.location = `/?playerID=${playerID}`;
            return
        }
        
        document.getElementById("hostname").innerHTML = "The host is " + info.hostName
        if (info.isPlayerHost==true){
            document.getElementById("adminonly").classList.add("d-flex")
        }

        update()
        setInterval(update, 1000)

        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                searchSongs();
            }
        });
    });

    async function searchSongs(){
        const input = document.getElementById('songinput');
        const searchButton = document.getElementById('searchbutton');
        const suggestions = document.getElementById('suggestions');

        const exampleAddSong = document.getElementById("exampleaddsong")

        if (!searching){
            $("#searchloader").show();
            input.disabled = true;
            searchButton.disabled = true;
            suggestions.innerHTML = '';
            searching=true
            const query = input.value;
            const response = await fetch(`/search?playerID=${playerID}&query=${query}`);
            const songs = await response.json();
            suggestions.innerHTML = '';
            songs.forEach(song => {
                let newAddSong = exampleAddSong.cloneNode(true)
                newAddSong.id = song.id
                newAddSong.getElementsByTagName("img")[0].src = song.album.images[0].url
                newAddSong.getElementsByClassName("yoursonglabel")[0].getElementsByClassName("songname")[0].innerHTML = song.name
                newAddSong.getElementsByClassName("yoursonglabel")[0].getElementsByClassName("songartist")[0].innerHTML = song.artists.map(artist => artist.name).join(', ')
                newAddSong.classList.remove("d-none");
                newAddSong.addEventListener('click', () => {
                    suggestions.innerHTML = '';
                    input.value='';
                    addSong(song);
                });
                suggestions.appendChild(newAddSong);
            });
            $("#searchloader").hide();
            input.disabled = false;
            searchButton.disabled = false;
            searching=false
        }
    }

    async function addSong(song){
        const response = await fetch(`/add?playerID=${playerID}`, {
                method: "POST",
                headers:{
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(song),
        });
        const body = await response.text();
        switch(body){
            case "Added":
                $('#addModalError').hide();
                $('#addModal').modal('hide');
                break;
            default:
                $('#addModalError').text(body);
                $('#addModalError').show();
                setTimeout(() => {
                    $('#addModalError').hide();
                },1000)
                break;
        }
        update()
    }

    async function update(){
        const response = await fetch(`/update?playerID=${playerID}`);
        const body = await response.json();

        if (!body.validGame) {
            window.location = `/?playerID=${playerID}`;
            return
        }
        
        if (!body.isPlaying){
            $('#staticBackdrop').modal('show');
            if (playlistLink != ""){
                $('#endGameBody').text("The link to the playlist here")
                document.getElementById("spotLink").classList.remove("d-none");
            }
            return
        }

        let currentsongids = body.items.map((song) => song.id);

        let examplesong = document.getElementById("examplesong")

        var yourssongs = document.getElementsByClassName("yoursong");

        Array.from(yourssongs).forEach((song) => {
            if (!currentsongids.includes(song.id)){
                song.remove()
                return
            }else{
                currentsongids.splice(currentsongids.indexOf(song.id),1);
            }
        })

        body.items.forEach((song,index) => {
            if (currentsongids.includes(song.id)){
                let newsong = examplesong.cloneNode(true)
                newsong.id = song.id
                newsong.getElementsByTagName("img")[0].src = song.album.images[0].url
                newsong.getElementsByClassName("yoursonglabel")[0].getElementsByClassName("songname")[0].innerHTML = song.name
                newsong.getElementsByClassName("yoursonglabel")[0].getElementsByClassName("songartist")[0].innerHTML = song.artists.map(artist => artist.name).join(', ')
                newsong.getElementsByTagName("button")[0].setAttribute( "onClick", "javascript: remove(this.parentNode.parentNode.id)");
                newsong.classList.add("yoursong");
                newsong.classList.remove("d-none");
                document.getElementById("yoursongs").appendChild(newsong)
            }
        })

        document.getElementById("playlistcount").innerHTML = body.count+" / "+(body.playerCount*body.songsPerPerson)
        document.getElementById("playercount").innerHTML = body.playerCount
        document.getElementById("yoursongcount").innerHTML = body.items.length + " / " + body.songsPerPerson
    }

    async function remove(id){
        await fetch(`/remove?playerID=${playerID}&songID=${id}`);
        update()
    }
    async function clearPlaylist(){
        await fetch(`/clear?playerID=${playerID}`,{method: "POST"});
        update()
    }
    async function submit(){
        var response = await fetch(`/submit?playerID=${playerID}`,{method: "POST"});
        const body = await response.text();
        playlistLink = body
    }

    async function leaveGame(){
        var response = await fetch(`/leaveGame?playerID=${playerID}`,{method: "POST"});
        window.location = `/?playerID=${playerID}`;
    }

    function uuidv4() {
        return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
            (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
    );
}
</script>